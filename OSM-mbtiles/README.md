# 发布 mbtiles 存储的矢量瓦片

之前我们分享过如何[在本地发布OSM矢量瓦片地图](http://gisarmory.xyz/blog/index.html?blog=OSMVectorTiles)，当时生成的矢量瓦片地图存放在 `.mbtiles` 文件中，然后用 tileserver-gl 软件发布。

> mbtiles 是基于sqllite数据库存储地图瓦片数据的标准规范，一个`.mbtiles`文件就是一个sqllite数据库。

最近遇到个问题，项目上需要将这份`.mbtiles`矢量瓦片数据部署到客户服务器上并发布。

之前也分享过[我的开源GIS解决方案](http://gisarmory.xyz/blog/index.html?blog=GISerSolution)，里面将 jdk、postgres、geoserver、tomcat 都搞成了绿色版，并且可以通过批处理脚本实现一键注册成系统服务，这样就形成了一个绿色版的安装包，部署时会很方便。

上面的架构是偏 java 体系的，而这次发布矢量瓦片用到的 tileserver-gl 是基于 nodejs 开发的，按上面的思路，需要将 nodejs 也搞一个绿色版的，并要能用批处理注册服务。

因为不想把安装包搞的太大，也不想用太多的技术体系，让后期维护变得太复杂，所以就想能不能在现有的技术体系下搞定 .mbtiles 文件发布的问题。

按这个思路，需要去研究有没有相关的geoserver插件，和有没有相关的java软件或项目。

## geoserver插件

先研究了geoserver插件，还真有。

geoserver有个mbtiles的扩展插件（链接），支持对mbtiles的读写。

但尝试后总觉得哪里不对劲。

 .mbtiles 文件中目前存的是处理好的pbf文件，按说插件只需要根据请求参数，返回对应的pbf文件就ok了。

从官网下载插件，安装尝试后发现个问题ss，  

用时能用，完全没有问题，但总觉得怪怪的，mbtiles 目前存的是处理好的pbf文件，我现在只需要有个后台根据前台的请求参数（xyz），返回对应的pbf文件就ok了，

但geoserver的做法是，将mbtiles 中的 pbf 文件作为矢量数据源来使用（类似于读取shp文件中的数据），具体为：先将pbf瓦片拼起来，读取拼接后的图层数据，再把图层发布成geoserver的矢量瓦片服务，最后在调用矢量瓦片服务时再将数据处理成pbf文件。

怎么说呢，这么做和把pbf文件直接扔给前台相比，结果是一样的，但就是感觉它内心戏太足，内耗太严重，还有就是发服务的过程也很麻烦。

只能说，这个插件设计的初衷就是用来读取数据，不是用来发布的。

## java项目

再来看看java这边。

在github上搜了一下，还真有，（项目名称、链接），还是个现成的java工程，拉取下来一通尝试，遇到几个问题：只支持png图片，不支持pbf发布的服务是tms类型的，在mapboxgl中调用时需要设置一下，参考之前写的这篇文章java后台返回pbf文件时，设置编码类型为gzip，和（内容类型）

最终，搞定。

这个通了，就简单了，我可以把这个工程直接编译成war包，仍到tomcat下就可以了。

流量地图时发现另一个问题，我只把地图切到了14级，因为矢量瓦片中，14级就包含的内容就已经很细了，并且也不大，所以没有必要再往下切。但用地图浏览时，超过14级后，地图就不显示了。

测试了 tileserver-gl 就没有这个问题，看来是后台需要把超过14级的请求参数出来一下，超过14级时，返回14级的瓦片翻了翻 tileserver-gl 的代码，没有找到相关逻辑的代码。

在同事的提醒下，发现前台请求时，15级和更高的版本直接就是按14级来请求的，这说明这个逻辑是在前台处理的。

去扒tileserver-gl 样例的地图样式配置，最终，发现对数据源设置maxzoom可以解决这个问题。

看一下官网的解释，大概意思是，如果你设置maxzoom=14，当地图缩放超过14级时，地图仍然会使用14级的瓦片
![img](file:///C:/Users/HERO/AppData/Local/Temp/enhtmlclip/Image.png)

## 总结：

本地发布的OSM矢量瓦片地图，生成的矢量瓦片存放在 mbtiles 文件中

发布mbtiles 中的矢量瓦片，主流的方式是 tileserver-gl ，它基于nodejs开发的

自己想搞一套基于java体系的工具，这样比较符合现在的架构

geoserver是将pbf作为矢量数据源来使用，一是逻辑不合理，二是这样操作比较麻烦

从github上找到了mbtiles4j项目，通过通过修改后，使它支持发布pbf

mapbox使用时，需要设置数据源的maxzoom

## 源码

