# 发布 mbtiles 存储的矢量瓦片

之前我们分享过如何[在本地发布OSM矢量瓦片地图](http://gisarmory.xyz/blog/index.html?blog=OSMVectorTiles)，当时生成的矢量瓦片地图存放在 `.mbtiles` 文件中，然后用 tileserver-gl 发布。

> mbtiles 是基于sqllite数据库存储地图瓦片数据的标准规范，一个`.mbtiles`文件就是一个sqllite数据库。

最近遇到个问题，项目上需要将这份矢量瓦片数据部署到客户服务器上并发布，之前的部署结构是，将 jdk、postgres、geoserver、tomcat 都搞成了绿色版，并且可以一键注册成系统服务，部署很方便，

这次的 tileserver-gl 是nodejs的，按之前的思路，需要将 nodejs 也搞一个绿色版的，并解决注册服务问题。

但之前的技术路线都是java 体系的，自己比较熟悉，nodejs前端开发时用的多，作为后端发服务使用的比较少，印象中没有java稳定。
所以就想着能不能在现有的体现下搞定 mbtiles 发布的问题。

先尝试了geoserver，geoserver有个mbtiles的扩展插件（链接），支持对mbtiles的读写，

从官网下载插件，安装尝试后发现个问题，

用时能用，完全没有问题，但总觉得怪怪的，mbtiles 目前存的是处理好的pbf文件，我现在只需要有个后台根据前台的请求参数（xyz），返回对应的pbf文件就ok了，

但geoserver的做法是，将mbtiles 中的 pbf 文件作为矢量数据源来使用（类似于shp），然后将这些矢量数据发布成geoserver的图层服务，再将这些图层服务创建成图层组，把图层组发布成矢量瓦片服务，

怎么说呢，行是行，就是有一种（举一个恰当的例子）的感觉，还有就是重新挨个发服务有点麻烦

不就是读取个现成的数据，返回给前台嘛，搞的这么负责，于是就想看看有没有现成的java项目，

在github上搜了一下，还真有，（项目名称、链接），还是个现成的java工程，拉取下来一通尝试，遇到几个问题：只支持png图片，不支持pbf发布的服务是tms类型的，在mapboxgl中调用时需要设置一下，参考之前写的这篇文章java后台返回pbf文件时，设置编码类型为gzip，和（内容类型）

最终，搞定。

这个通了，就简单了，我可以把这个工程直接编译成war包，仍到tomcat下就可以了。

流量地图时发现另一个问题，我只把地图切到了14级，因为矢量瓦片中，14级就包含的内容就已经很细了，并且也不大，所以没有必要再往下切。但用地图浏览时，超过14级后，地图就不显示了。

测试了 tileserver-gl 就没有这个问题，看来是后台需要把超过14级的请求参数出来一下，超过14级时，返回14级的瓦片翻了翻 tileserver-gl 的代码，没有找到相关逻辑的代码。

在同事的提醒下，发现前台请求时，15级和更高的版本直接就是按14级来请求的，这说明这个逻辑是在前台处理的。

去扒tileserver-gl 样例的地图样式配置，最终，发现对数据源设置maxzoom可以解决这个问题。

看一下官网的解释，大概意思是，如果你设置maxzoom=14，当地图缩放超过14级时，地图仍然会使用14级的瓦片
![img](file:///C:/Users/HERO/AppData/Local/Temp/enhtmlclip/Image.png)

## 总结：

本地发布的OSM矢量瓦片地图，生成的矢量瓦片存放在 mbtiles 文件中

发布mbtiles 中的矢量瓦片，主流的方式是 tileserver-gl ，它基于nodejs开发的

自己想搞一套基于java体系的工具，这样比较符合现在的架构

geoserver是将pbf作为矢量数据源来使用，一是逻辑不合理，二是这样操作比较麻烦

从github上找到了mbtiles4j项目，通过通过修改后，使它支持发布pbf

mapbox使用时，需要设置数据源的maxzoom

## 源码

